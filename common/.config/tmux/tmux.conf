# ============================================================================
# Prefix Configuration
# ============================================================================

# Set True color
set-option -sa terminal-overrides ",xterm-256color:Tc"

# Set prefix to Alt+Space
unbind C-b
set -g prefix M-Space
bind M-Space send-prefix

# ============================================================================
# TPM (Tmux Plugin Manager)
# ============================================================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'niksingh710/minimal-tmux-status'
set -g @plugin 'fcsonline/tmux-thumbs'

# Floax configuration
set -g @floax-width '80%'
set -g @floax-height '80%'
set -g @floax-border-color '#98bb6c'
set -g @floax-text-color '#dcd7ba'

# TPM keybindings (using prefix for admin tasks)
bind i run-shell '~/.config/tmux/plugins/tpm/bindings/install_plugins'
bind u run-shell '~/.config/tmux/plugins/tpm/bindings/update_plugins'
bind C run-shell '~/.config/tmux/plugins/tpm/bindings/clean_plugins'

# tmux-thumbs
run-shell ~/.config/tmux/plugins/tmux-thumbs/tmux-thumbs.tmux

# ============================================================================
# General Settings
# ============================================================================

# Enable mouse support
set -g mouse on

set-option -g history-limit 50000
set-option -g display-time 4000
set-option -g status-interval 5

# address vim mode switching delay (http://superuser.com/a/252717/65504)
set-option -s escape-time 0

# Enable 256 color support
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*256col*:Tc"

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# No delay for escape key
set -sg escape-time 0

# Enable clipboard
set -g set-clipboard on

# Enable focus events for vim/neovim
set -g focus-events on

set-window-option -g aggressive-resize on

# ============================================================================
# Keybindings (matching Zellij Alt-based bindings)
# ============================================================================

# Unbind default prefix (Ctrl-b)
unbind C-b
# No prefix needed since we're using Alt everywhere

# ============================================================================
# Pane Creation (Alt + hjkl like Zellij)
# ============================================================================

bind -n M-h split-window -hb -c "#{pane_current_path}"  # left
bind -n M-j split-window -v -c "#{pane_current_path}"   # down
bind -n M-k split-window -vb -c "#{pane_current_path}"  # up
bind -n M-l split-window -h -c "#{pane_current_path}"   # right

# ============================================================================
# Tab Navigation (Alt + number like Zellij)
# ============================================================================

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# ============================================================================
# Tab Management (matching Zellij Alt-t mode)
# ============================================================================

# Enter "tab mode" with Alt-t, then use single keys
bind -n M-t switch-client -T tab-mode

bind -T tab-mode n new-window -c "#{pane_current_path}"
bind -T tab-mode x kill-window
bind -T tab-mode r command-prompt -I "#W" "rename-window '%%'"
bind -T tab-mode h previous-window
bind -T tab-mode l next-window
bind -T tab-mode Tab last-window
bind -T tab-mode s set-window-option synchronize-panes\; display-message "Sync: #{?synchronize-panes,ON,OFF}"

# ============================================================================
# Pane Management (matching Zellij Alt-a mode)
# ============================================================================

bind -n M-a switch-client -T pane-mode

bind -T pane-mode z resize-pane -Z  # toggle zoom (fullscreen)
bind -T pane-mode f resize-pane -Z  # same as z

# ============================================================================
# Move Mode (matching Zellij Alt-m mode)
# ============================================================================

bind -n M-m switch-client -T move-mode

# Resize panes
bind -T move-mode H resize-pane -L 5
bind -T move-mode J resize-pane -D 5
bind -T move-mode K resize-pane -U 5
bind -T move-mode L resize-pane -R 5
bind -T move-mode M-h resize-pane -L 1
bind -T move-mode M-j resize-pane -D 1
bind -T move-mode M-k resize-pane -U 1
bind -T move-mode M-l resize-pane -R 1

# Swap panes
bind -T move-mode h swap-pane -U
bind -T move-mode j swap-pane -D
bind -T move-mode k swap-pane -U
bind -T move-mode l swap-pane -D

# ============================================================================
# Session Management (matching Zellij Alt-g mode)
# ============================================================================

bind -n M-g switch-client -T session-mode

bind -T session-mode d detach-client
bind -T session-mode g choose-tree -Zs

# ============================================================================
# Scroll Mode (matching Zellij Alt-s)
# ============================================================================

bind -n M-s copy-mode

# In copy mode, use vim-style navigation
setw -g mode-keys vi

bind -T copy-mode-vi j send-keys -X cursor-down
bind -T copy-mode-vi k send-keys -X cursor-up
bind -T copy-mode-vi h send-keys -X cursor-left
bind -T copy-mode-vi l send-keys -X cursor-right
bind -T copy-mode-vi d send-keys -X halfpage-down
bind -T copy-mode-vi u send-keys -X halfpage-up
bind -T copy-mode-vi G send-keys -X history-bottom
bind -T copy-mode-vi g send-keys -X history-top
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel
bind -T copy-mode-vi / command-prompt -p "search down" "send -X search-forward \"%%%\""
bind -T copy-mode-vi ? command-prompt -p "search up" "send -X search-backward \"%%%\""
bind -T copy-mode-vi n send-keys -X search-again
bind -T copy-mode-vi N send-keys -X search-reverse

# ============================================================================
# Floating Panes (using tmux-floax plugin)
# ============================================================================

# Alt+w for floating popup terminal (toggles on/off with floax)
bind -n M-w run-shell '~/.config/tmux/plugins/tmux-floax/scripts/floax.sh'

# Alt+f for floating file picker popup
bind -n M-f run-shell 'tmux set-buffer "#{pane_id}" \; display-popup -E -w 80% -h 80% -d "#{pane_current_path}" "yazi-tmux-picker"'

# ============================================================================
# Other Zellij-like bindings
# ============================================================================

# Alt+x - kill pane (but not if it's the last one)
bind -n M-x if-shell '[ $(tmux list-panes | wc -l) -gt 1 ]' \
    'if-shell "tmux display-message -p \"#{pane_current_command}\" | grep -iq nvim" \
        "confirm-before -p \"Kill pane running nvim? (y/n)\" kill-pane" \
        "kill-pane"' \
    'display-message "Cannot close last pane"'

# Alt+d - detach from session
bind -n M-d detach-client

# Alt+Shift+D - kill session (with confirmation)
bind -n M-D confirm-before -p "Kill session #S? (y/n)" kill-session

# Alt+q - quick detach (keeping old binding)
bind -n M-q detach-client

# Alt+Shift+Q - kill tmux server (all sessions)
bind -n M-Q confirm-before -p "Kill tmux server? (y/n)" kill-server


# ============================================================================
# Prefix-based Administrative Commands
# ============================================================================

# Prefix + r - reload config
bind r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded"

# Locked mode (Alt-o to toggle)
bind L set-option -g prefix None \; set-option -g key-table locked \; display-message "LOCKED"
bind -T locked L set-option -g prefix M-Space \; set-option -g key-table root \; display-message "UNLOCKED"

# Prefix + : - command prompt
bind : command-prompt

# Prefix + ? - show all keybindings
bind ? list-keys

# Prefix + I - show tmux info
bind I display-message "tmux #{version}"

# Prefix + Shift+D - detach all other clients
bind D detach-client -a

# Prefix + Shift+Q - kill all other sessions
bind Q confirm-before -p "Kill all other sessions? (y/n)" "kill-session -a"

# ============================================================================
# Visual Styling (minimal centered pill-style status bar)
# ============================================================================

# automatic rename
setw -g automatic-rename on

# arrow styles (rounded box)
set -g @minimal-tmux-use-arrow true
set -g @minimal-tmux-right-arrow ""
set -g @minimal-tmux-left-arrow ""

# copy mode
setw -g mode-style bg=#2d4f67,fg=#dcd7ba

# clock mode
setw -g clock-mode-colour "#7e9cd8"

# ============================================================================
# Additional Quality of Life
# ============================================================================

# Prefix-based split commands (traditional tmux style)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"

bind l split-window -h -c "#{pane_current_path}"
bind j split-window -v -c "#{pane_current_path}"

bind '"' split-window -v -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"

# Prefix + x - kill pane with confirmation
bind x confirm-before -p "Kill pane? (y/n)" kill-pane

# Prefix + & - kill window with confirmation  
bind & confirm-before -p "Kill window? (y/n)" kill-window

# Clear screen and history
bind -n M-C-l send-keys C-l \; clear-history

# ============================================================================
# Initialize TPM (must be at the very end)
# ============================================================================

run '~/.config/tmux/plugins/tpm/tpm'
